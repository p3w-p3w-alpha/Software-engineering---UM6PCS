<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAMS - Assignments</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

    <div class="sidebar">
        <div class="sidebar-header"><i class="bi bi-mortarboard-fill me-2"></i><span>SAMS</span></div>
        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-link"><i class="bi bi-house-door"></i> Dashboard</a>
            <a href="courses.html" class="nav-link"><i class="bi bi-book"></i> Courses</a>
            <a href="enrollments.html" class="nav-link"><i class="bi bi-journal-check"></i> My Enrollments</a>
            <a href="assignments.html" class="nav-link active"><i class="bi bi-file-earmark-text"></i> Assignments</a>
            <a href="grades.html" class="nav-link"><i class="bi bi-bar-chart"></i> Grades</a>
            <a href="study-groups.html" class="nav-link"><i class="bi bi-people"></i> Study Groups</a>
            <a href="connections.html" class="nav-link"><i class="bi bi-person-lines-fill"></i> Connections</a>
            <a href="messages.html" class="nav-link"><i class="bi bi-chat-dots"></i> Messages</a>
            <a href="notifications.html" class="nav-link"><i class="bi bi-bell"></i> Notifications</a>
        </nav>
        <div class="sidebar-footer">
            <div class="user-info"><i class="bi bi-person-circle me-2"></i><span id="userName">Loading...</span></div>
            <button class="btn btn-sm btn-outline-light w-100 mt-2" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Logout</button>
        </div>
    </div>

    <div class="main-content">
        <div class="content-header">
            <h1>Assignments</h1>
            <button class="btn btn-primary" onclick="loadAssignments()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
        </div>

        <div class="content-body">
            <ul class="nav nav-tabs mb-4">
                <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#pending">Pending</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#submitted">Submitted</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#graded">Graded</a></li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="pending">
                    <div id="pendingAssignments"><div class="text-center py-5"><div class="spinner-border text-primary"></div></div></div>
                </div>
                <div class="tab-pane fade" id="submitted">
                    <div id="submittedAssignments"><div class="text-center py-5"><div class="spinner-border text-primary"></div></div></div>
                </div>
                <div class="tab-pane fade" id="graded">
                    <div id="gradedAssignments"><div class="text-center py-5"><div class="spinner-border text-primary"></div></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Submit Assignment Modal -->
    <div class="modal fade" id="submitModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Submit Assignment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="submitForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Assignment</label>
                            <input type="text" class="form-control" id="assignmentTitle" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Choose File</label>
                            <input type="file" class="form-control" id="fileInput" required>
                            <small class="text-muted">Max size: 10MB. Allowed: PDF, DOCX, ZIP, etc.</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary"><i class="bi bi-upload"></i> Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    <script>
        checkAuth();
        const user = getCurrentUser();
        document.getElementById('userName').textContent = user.username;

        let currentAssignment = null;
        const submitModal = new bootstrap.Modal(document.getElementById('submitModal'));

        async function loadAssignments() {
            try {
                const assignments = await apiCall(`/assignments/student/${user.id}`);
                const submissions = await apiCall(`/submissions/student/${user.id}`);

                const submittedIds = new Set(submissions.map(s => s.assignmentId));

                const pending = assignments.filter(a => !submittedIds.has(a.id) && new Date(a.dueDate) > new Date());
                const submitted = submissions.filter(s => s.status === 'SUBMITTED');
                const graded = submissions.filter(s => s.status === 'GRADED' || s.status === 'RETURNED');

                displayAssignments(pending, 'pendingAssignments', 'pending');
                displayAssignments(submitted, 'submittedAssignments', 'submitted');
                displayAssignments(graded, 'gradedAssignments', 'graded');
            } catch (error) {
                console.error('Error loading assignments:', error);
                showToast('Error loading assignments', 'error');
            }
        }

        function displayAssignments(items, containerId, type) {
            const container = document.getElementById(containerId);

            if (!items || items.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No assignments</div>';
                return;
            }

            let html = '<div class="list-group">';
            items.forEach(item => {
                const isPending = type === 'pending';
                const assignment = isPending ? item : item.assignment;
                const dueDate = isPending ? new Date(item.dueDate) : new Date(assignment.dueDate);
                const isOverdue = dueDate < new Date();

                html += `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${isPending ? item.title : item.assignmentTitle}</h6>
                                <p class="mb-1 text-muted">${isPending ? item.courseName : ''}</p>
                                <small>Due: ${formatDate(dueDate)} ${isOverdue ? '<span class="badge bg-danger">Overdue</span>' : ''}</small>
                                ${type === 'graded' ? `<br><strong>Score: ${item.finalScore}/${item.maxPoints}</strong>` : ''}
                            </div>
                            <div>
                                ${isPending ? `<button class="btn btn-sm btn-primary" onclick="showSubmitModal(${item.id}, '${item.title}')">Submit</button>` : ''}
                                ${type === 'submitted' ? '<span class="badge bg-warning">Pending Grade</span>' : ''}
                                ${type === 'graded' ? `<button class="btn btn-sm btn-info" onclick="viewFeedback(${item.id})">View Feedback</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function showSubmitModal(assignmentId, title) {
            currentAssignment = assignmentId;
            document.getElementById('assignmentTitle').value = title;
            submitModal.show();
        }

        document.getElementById('submitForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) {
                showToast('Please select a file', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_BASE}/submissions/submit?assignmentId=${currentAssignment}&studentId=${user.id}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: formData
                });

                if (response.ok) {
                    showToast('Assignment submitted successfully!', 'success');
                    submitModal.hide();
                    document.getElementById('submitForm').reset();
                    loadAssignments();
                } else {
                    const error = await response.text();
                    showToast('Submission failed: ' + error, 'error');
                }
            } catch (error) {
                showToast('Error submitting assignment', 'error');
            }
        });

        async function viewFeedback(submissionId) {
            try {
                const submission = await apiCall(`/submissions/${submissionId}`);
                alert(`Score: ${submission.finalScore}/${submission.maxPoints}\n\nFeedback: ${submission.feedback || 'No feedback provided'}`);
            } catch (error) {
                showToast('Error loading feedback', 'error');
            }
        }

        loadAssignments();
    </script>
</body>
</html>
