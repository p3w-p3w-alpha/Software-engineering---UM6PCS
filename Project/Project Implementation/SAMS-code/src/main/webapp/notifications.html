<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAMS - Notifications</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

    <div class="sidebar">
        <div class="sidebar-header"><i class="bi bi-mortarboard-fill me-2"></i><span>SAMS</span></div>
        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-link"><i class="bi bi-house-door"></i> Dashboard</a>
            <a href="courses.html" class="nav-link"><i class="bi bi-book"></i> Courses</a>
            <a href="enrollments.html" class="nav-link"><i class="bi bi-journal-check"></i> My Enrollments</a>
            <a href="assignments.html" class="nav-link"><i class="bi bi-file-earmark-text"></i> Assignments</a>
            <a href="grades.html" class="nav-link"><i class="bi bi-bar-chart"></i> Grades</a>
            <a href="study-groups.html" class="nav-link"><i class="bi bi-people"></i> Study Groups</a>
            <a href="connections.html" class="nav-link"><i class="bi bi-person-lines-fill"></i> Connections</a>
            <a href="messages.html" class="nav-link"><i class="bi bi-chat-dots"></i> Messages</a>
            <a href="notifications.html" class="nav-link active"><i class="bi bi-bell"></i> Notifications</a>
        </nav>
        <div class="sidebar-footer">
            <div class="user-info"><i class="bi bi-person-circle me-2"></i><span id="userName">Loading...</span></div>
            <button class="btn btn-sm btn-outline-light w-100 mt-2" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Logout</button>
        </div>
    </div>

    <div class="main-content">
        <div class="content-header">
            <h1>Notifications</h1>
            <div>
                <button class="btn btn-outline-primary me-2" onclick="markAllAsRead()">
                    <i class="bi bi-check2-all"></i> Mark All Read
                </button>
                <button class="btn btn-outline-danger me-2" onclick="deleteAllRead()">
                    <i class="bi bi-trash"></i> Delete Read
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#preferencesModal">
                    <i class="bi bi-gear"></i> Preferences
                </button>
            </div>
        </div>

        <div class="content-body">
            <!-- Filter Bar -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-md-4">
                            <select class="form-select" id="typeFilter" onchange="loadNotifications()">
                                <option value="">All Types</option>
                                <option value="ENROLLMENT">Enrollment</option>
                                <option value="GRADE">Grade</option>
                                <option value="ASSIGNMENT">Assignment</option>
                                <option value="MESSAGE">Message</option>
                                <option value="CONNECTION">Connection</option>
                                <option value="STUDY_GROUP">Study Group</option>
                                <option value="SYSTEM">System</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="statusFilter" onchange="loadNotifications()">
                                <option value="">All Status</option>
                                <option value="unread">Unread Only</option>
                                <option value="read">Read Only</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary w-100" onclick="loadNotifications()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notifications List -->
            <div id="notificationsContainer">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary"></div>
                </div>
            </div>

            <!-- Pagination -->
            <nav id="paginationNav" style="display: none;">
                <ul class="pagination justify-content-center" id="pagination"></ul>
            </nav>
        </div>
    </div>

    <!-- Preferences Modal -->
    <div class="modal fade" id="preferencesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Notification Preferences</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="preferencesBody">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="savePreferences()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    <script>
        checkAuth();
        const user = getCurrentUser();
        document.getElementById('userName').textContent = user.username;

        let currentPage = 0;
        const pageSize = 15;
        let totalPages = 0;

        async function loadNotifications() {
            try {
                const typeFilter = document.getElementById('typeFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;

                let endpoint = `/notifications?userId=${user.id}&page=${currentPage}&size=${pageSize}`;
                if (typeFilter) {
                    endpoint += `&type=${typeFilter}`;
                }
                if (statusFilter === 'unread') {
                    endpoint += `&unreadOnly=true`;
                } else if (statusFilter === 'read') {
                    endpoint += `&readOnly=true`;
                }

                const response = await apiCall(endpoint);
                displayNotifications(response.content || []);

                totalPages = response.totalPages || 0;
                updatePagination();

            } catch (error) {
                console.error('Error loading notifications:', error);
                showToast('Error loading notifications', 'error');
            }
        }

        function displayNotifications(notifications) {
            const container = document.getElementById('notificationsContainer');

            if (notifications.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No notifications found</div>';
                return;
            }

            let html = '<div class="list-group">';
            notifications.forEach(notif => {
                const icon = getNotificationIcon(notif.type);
                const readClass = notif.read ? '' : 'border-primary border-2';
                const bgClass = notif.read ? '' : 'bg-light';

                html += `
                    <div class="list-group-item ${readClass} ${bgClass}">
                        <div class="d-flex w-100 justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="${icon} me-2 fs-4"></i>
                                    <div>
                                        <h6 class="mb-0">${notif.title}</h6>
                                        ${!notif.read ? '<span class="badge bg-primary ms-2">New</span>' : ''}
                                        <span class="badge bg-secondary ms-1">${notif.type}</span>
                                    </div>
                                </div>
                                <p class="mb-2">${notif.message}</p>
                                <small class="text-muted">
                                    <i class="bi bi-clock"></i> ${formatDate(notif.createdAt)}
                                </small>
                            </div>
                            <div class="btn-group-vertical ms-3">
                                ${!notif.read ? `
                                    <button class="btn btn-sm btn-outline-primary" onclick="markAsRead(${notif.id})" title="Mark as read">
                                        <i class="bi bi-check2"></i>
                                    </button>
                                ` : ''}
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteNotification(${notif.id})" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function updatePagination() {
            const paginationNav = document.getElementById('paginationNav');
            const pagination = document.getElementById('pagination');

            if (totalPages <= 1) {
                paginationNav.style.display = 'none';
                return;
            }

            paginationNav.style.display = 'block';
            let html = '';

            // Previous button
            html += `
                <li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Previous</a>
                </li>
            `;

            // Page numbers
            for (let i = 0; i < totalPages; i++) {
                if (i === 0 || i === totalPages - 1 || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i + 1}</a>
                        </li>
                    `;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }

            // Next button
            html += `
                <li class="page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Next</a>
                </li>
            `;

            pagination.innerHTML = html;
        }

        function changePage(page) {
            if (page >= 0 && page < totalPages) {
                currentPage = page;
                loadNotifications();
            }
        }

        async function markAsRead(notificationId) {
            try {
                await apiCall(`/notifications/${notificationId}/read`, 'PUT');
                loadNotifications();
            } catch (error) {
                showToast('Error marking notification as read', 'error');
            }
        }

        async function markAllAsRead() {
            try {
                await apiCall(`/notifications/mark-all-read?userId=${user.id}`, 'PUT');
                showToast('All notifications marked as read', 'success');
                loadNotifications();
            } catch (error) {
                showToast('Error marking all as read', 'error');
            }
        }

        async function deleteNotification(notificationId) {
            if (!confirm('Are you sure you want to delete this notification?')) return;

            try {
                await apiCall(`/notifications/${notificationId}`, 'DELETE');
                showToast('Notification deleted', 'success');
                loadNotifications();
            } catch (error) {
                showToast('Error deleting notification', 'error');
            }
        }

        async function deleteAllRead() {
            if (!confirm('Are you sure you want to delete all read notifications?')) return;

            try {
                await apiCall(`/notifications/delete-read?userId=${user.id}`, 'DELETE');
                showToast('Read notifications deleted', 'success');
                loadNotifications();
            } catch (error) {
                showToast('Error deleting notifications', 'error');
            }
        }

        function getNotificationIcon(type) {
            const icons = {
                'ENROLLMENT': 'bi bi-journal-check text-primary',
                'GRADE': 'bi bi-bar-chart text-success',
                'ASSIGNMENT': 'bi bi-file-earmark-text text-info',
                'MESSAGE': 'bi bi-chat-dots text-warning',
                'CONNECTION': 'bi bi-person-check text-info',
                'STUDY_GROUP': 'bi bi-people text-primary',
                'SYSTEM': 'bi bi-info-circle text-secondary'
            };
            return icons[type] || 'bi bi-bell text-secondary';
        }

        // Preferences Modal
        document.getElementById('preferencesModal').addEventListener('show.bs.modal', loadPreferences);

        async function loadPreferences() {
            try {
                const prefs = await apiCall(`/notifications/preferences/${user.id}`);
                displayPreferences(prefs);
            } catch (error) {
                console.error('Error loading preferences:', error);
                document.getElementById('preferencesBody').innerHTML = '<p class="text-danger">Error loading preferences</p>';
            }
        }

        function displayPreferences(prefs) {
            const types = ['ENROLLMENT', 'GRADE', 'ASSIGNMENT', 'MESSAGE', 'CONNECTION', 'STUDY_GROUP', 'SYSTEM'];

            let html = '<div class="table-responsive"><table class="table table-hover">';
            html += '<thead><tr><th>Notification Type</th><th>Email</th><th>In-App</th><th>Push</th></tr></thead><tbody>';

            types.forEach(type => {
                const pref = prefs.find(p => p.notificationType === type) || {
                    notificationType: type,
                    emailEnabled: true,
                    inAppEnabled: true,
                    pushEnabled: false
                };

                html += `
                    <tr>
                        <td><strong>${type.replace('_', ' ')}</strong></td>
                        <td>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="email_${type}" ${pref.emailEnabled ? 'checked' : ''}>
                            </div>
                        </td>
                        <td>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="inapp_${type}" ${pref.inAppEnabled ? 'checked' : ''}>
                            </div>
                        </td>
                        <td>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="push_${type}" ${pref.pushEnabled ? 'checked' : ''}>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            document.getElementById('preferencesBody').innerHTML = html;
        }

        async function savePreferences() {
            const types = ['ENROLLMENT', 'GRADE', 'ASSIGNMENT', 'MESSAGE', 'CONNECTION', 'STUDY_GROUP', 'SYSTEM'];
            const preferences = [];

            types.forEach(type => {
                preferences.push({
                    notificationType: type,
                    emailEnabled: document.getElementById(`email_${type}`).checked,
                    inAppEnabled: document.getElementById(`inapp_${type}`).checked,
                    pushEnabled: document.getElementById(`push_${type}`).checked
                });
            });

            try {
                await apiCall(`/notifications/preferences/${user.id}`, 'PUT', preferences);
                showToast('Preferences saved successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('preferencesModal')).hide();
            } catch (error) {
                showToast('Error saving preferences', 'error');
            }
        }

        loadNotifications();
    </script>
</body>
</html>
