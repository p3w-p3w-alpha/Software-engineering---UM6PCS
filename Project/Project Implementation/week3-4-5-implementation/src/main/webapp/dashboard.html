<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAMS - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <i class="bi bi-mortarboard-fill me-2"></i>
            <span>SAMS</span>
        </div>

        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-link active">
                <i class="bi bi-house-door"></i> Dashboard
            </a>
            <a href="courses.html" class="nav-link">
                <i class="bi bi-book"></i> Courses
            </a>
            <a href="enrollments.html" class="nav-link">
                <i class="bi bi-journal-check"></i> My Enrollments
            </a>
            <a href="assignments.html" class="nav-link">
                <i class="bi bi-file-earmark-text"></i> Assignments
            </a>
            <a href="grades.html" class="nav-link">
                <i class="bi bi-bar-chart"></i> Grades
            </a>
            <a href="study-groups.html" class="nav-link">
                <i class="bi bi-people"></i> Study Groups
            </a>
            <a href="connections.html" class="nav-link">
                <i class="bi bi-person-lines-fill"></i> Connections
            </a>
            <a href="messages.html" class="nav-link">
                <i class="bi bi-chat-dots"></i> Messages
                <span class="badge bg-danger ms-auto" id="unreadMsgBadge" style="display:none;">0</span>
            </a>
            <a href="notifications.html" class="nav-link">
                <i class="bi bi-bell"></i> Notifications
                <span class="badge bg-danger ms-auto" id="unreadNotifBadge" style="display:none;">0</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <div class="user-info">
                <i class="bi bi-person-circle me-2"></i>
                <span id="userName">Loading...</span>
            </div>
            <button class="btn btn-sm btn-outline-light w-100 mt-2" onclick="logout()">
                <i class="bi bi-box-arrow-right"></i> Logout
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="content-header">
            <h1>Dashboard</h1>
            <div class="d-flex align-items-center">
                <span class="me-3" id="currentDate"></span>
                <button class="btn btn-primary btn-sm" onclick="loadDashboard()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div class="content-body">
            <!-- Stats Cards -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-icon bg-primary">
                            <i class="bi bi-book"></i>
                        </div>
                        <div class="stats-info">
                            <h3 id="enrollmentCount">0</h3>
                            <p>Active Enrollments</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-icon bg-success">
                            <i class="bi bi-file-earmark-check"></i>
                        </div>
                        <div class="stats-info">
                            <h3 id="assignmentCount">0</h3>
                            <p>Pending Assignments</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-icon bg-info">
                            <i class="bi bi-people"></i>
                        </div>
                        <div class="stats-info">
                            <h3 id="groupCount">0</h3>
                            <p>Study Groups</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-icon bg-warning">
                            <i class="bi bi-person-check"></i>
                        </div>
                        <div class="stats-info">
                            <h3 id="connectionCount">0</h3>
                            <p>Connections</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Two Column Layout -->
            <div class="row g-3">
                <!-- Recent Activity -->
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Recent Notifications</h5>
                        </div>
                        <div class="card-body">
                            <div id="recentNotifications">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Quick Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <a href="courses.html" class="btn btn-outline-primary">
                                    <i class="bi bi-search me-2"></i>Browse Courses
                                </a>
                                <a href="study-groups.html" class="btn btn-outline-success">
                                    <i class="bi bi-plus-circle me-2"></i>Create Study Group
                                </a>
                                <a href="connections.html" class="btn btn-outline-info">
                                    <i class="bi bi-person-plus me-2"></i>Find Connections
                                </a>
                                <a href="assignments.html" class="btn btn-outline-warning">
                                    <i class="bi bi-file-earmark me-2"></i>Submit Assignment
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header">
                            <h5 class="mb-0">Upcoming Deadlines</h5>
                        </div>
                        <div class="card-body">
                            <div id="upcomingDeadlines">
                                <p class="text-muted">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    <script>
        checkAuth();

        // Display current date
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Display user name
        const user = getCurrentUser();
        document.getElementById('userName').textContent = user.username;

        // Load dashboard data
        async function loadDashboard() {
            try {
                // Load stats
                await loadStats();

                // Load recent notifications
                await loadRecentNotifications();

                // Load upcoming deadlines
                await loadUpcomingDeadlines();

                // Update unread counts
                await updateUnreadCounts();

            } catch (error) {
                console.error('Error loading dashboard:', error);
                showToast('Error loading dashboard data', 'error');
            }
        }

        async function loadStats() {
            const user = getCurrentUser();

            // Get enrollments count
            try {
                const enrollments = await apiCall(`/enrollments/student/${user.id}`);
                const activeEnrollments = enrollments.filter(e => e.status === 'ACTIVE');
                document.getElementById('enrollmentCount').textContent = activeEnrollments.length;
            } catch (error) {
                console.error('Error loading enrollments:', error);
            }

            // Get pending assignments count
            try {
                const assignments = await apiCall(`/assignments/student/${user.id}`);
                const pending = assignments.filter(a => !a.submitted && new Date(a.dueDate) > new Date());
                document.getElementById('assignmentCount').textContent = pending.length;
            } catch (error) {
                console.error('Error loading assignments:', error);
            }

            // Get study groups count
            try {
                const groups = await apiCall(`/study-groups/user/${user.id}/groups`);
                document.getElementById('groupCount').textContent = groups.length;
            } catch (error) {
                console.error('Error loading groups:', error);
            }

            // Get connections count
            try {
                const data = await apiCall(`/connections/user/${user.id}/count`);
                document.getElementById('connectionCount').textContent = data.connections || 0;
            } catch (error) {
                console.error('Error loading connections:', error);
            }
        }

        async function loadRecentNotifications() {
            try {
                const user = getCurrentUser();
                const notifications = await apiCall(`/notifications?userId=${user.id}&page=0&size=5`);

                const container = document.getElementById('recentNotifications');

                if (!notifications.content || notifications.content.length === 0) {
                    container.innerHTML = '<p class="text-muted">No recent notifications</p>';
                    return;
                }

                let html = '<div class="list-group list-group-flush">';
                notifications.content.forEach(notif => {
                    const icon = getNotificationIcon(notif.type);
                    const badge = notif.read ? '' : '<span class="badge bg-primary">New</span>';
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1"><i class="${icon} me-2"></i>${notif.title}</h6>
                                ${badge}
                            </div>
                            <p class="mb-1">${notif.message}</p>
                            <small class="text-muted">${formatDate(notif.createdAt)}</small>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;

            } catch (error) {
                document.getElementById('recentNotifications').innerHTML = '<p class="text-danger">Error loading notifications</p>';
            }
        }

        async function loadUpcomingDeadlines() {
            try {
                const user = getCurrentUser();
                const assignments = await apiCall(`/assignments/student/${user.id}`);

                const upcoming = assignments
                    .filter(a => new Date(a.dueDate) > new Date())
                    .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))
                    .slice(0, 5);

                const container = document.getElementById('upcomingDeadlines');

                if (upcoming.length === 0) {
                    container.innerHTML = '<p class="text-muted">No upcoming deadlines</p>';
                    return;
                }

                let html = '<div class="list-group list-group-flush">';
                upcoming.forEach(assignment => {
                    const dueDate = new Date(assignment.dueDate);
                    const daysUntil = Math.ceil((dueDate - new Date()) / (1000 * 60 * 60 * 24));
                    const urgentClass = daysUntil <= 2 ? 'text-danger' : daysUntil <= 7 ? 'text-warning' : '';

                    html += `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${assignment.title}</h6>
                                <small class="${urgentClass}">${daysUntil} days</small>
                            </div>
                            <small class="text-muted">${assignment.courseName}</small>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;

            } catch (error) {
                document.getElementById('upcomingDeadlines').innerHTML = '<p class="text-muted">No deadlines</p>';
            }
        }

        async function updateUnreadCounts() {
            try {
                const user = getCurrentUser();

                // Unread notifications
                const notifData = await apiCall(`/notifications/unread-count?userId=${user.id}`);
                if (notifData.count > 0) {
                    const badge = document.getElementById('unreadNotifBadge');
                    badge.textContent = notifData.count;
                    badge.style.display = 'inline-block';
                }

                // Unread messages
                const msgData = await apiCall(`/messages/user/${user.id}/unread-count`);
                if (msgData.unreadCount > 0) {
                    const badge = document.getElementById('unreadMsgBadge');
                    badge.textContent = msgData.unreadCount;
                    badge.style.display = 'inline-block';
                }

            } catch (error) {
                console.error('Error updating unread counts:', error);
            }
        }

        function getNotificationIcon(type) {
            const icons = {
                'ENROLLMENT': 'bi bi-journal-check text-primary',
                'GRADE': 'bi bi-bar-chart text-success',
                'ASSIGNMENT': 'bi bi-file-earmark-text text-info',
                'MESSAGE': 'bi bi-chat-dots text-warning',
                'CONNECTION': 'bi bi-person-check text-info',
                'STUDY_GROUP': 'bi bi-people text-primary'
            };
            return icons[type] || 'bi bi-bell text-secondary';
        }

        // Load dashboard on page load
        loadDashboard();
    </script>
</body>
</html>
